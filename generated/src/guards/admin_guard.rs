// Auto-generated by db-gen. Do not edit.
use async_trait::async_trait;
use core_db::common::sql::DbConn;
use core_db::platform::personal_access_tokens::model::PersonalAccessTokenRow;
use core_db::platform::personal_access_tokens::repo::PatRepo;
use uuid::Uuid;
use core_web::auth::Guard;
use crate::generated::models::admin::{AdminView, AdminQuery};

/// AdminGuard Guard
#[derive(Clone, Copy)]
pub struct AdminGuard;

#[async_trait]
impl Guard for AdminGuard {
    type User = AdminView;
    fn name() -> &'static str {
        "admin"
    }
    fn tokenable_type() -> Option<&'static str> {
        Some("admin")
    }
    async fn fetch_user<'a>(db: DbConn<'a>, id: Uuid) -> anyhow::Result<Option<Self::User>> {
        AdminQuery::new(db, None).find(id).await
    }
}

pub async fn list_tokens<'a>(db: DbConn<'a>, subject_id: Uuid) -> anyhow::Result<Vec<PersonalAccessTokenRow>> {
    let tokenable_type = <AdminGuard as Guard>::tokenable_type().unwrap_or(<AdminGuard as Guard>::name());
    PatRepo::new(db).list_by_subject(tokenable_type, subject_id).await
}

pub async fn revoke_tokens<'a>(db: DbConn<'a>, subject_id: Uuid) -> anyhow::Result<u64> {
    let tokenable_type = <AdminGuard as Guard>::tokenable_type().unwrap_or(<AdminGuard as Guard>::name());
    PatRepo::new(db).revoke_by_subject(tokenable_type, subject_id).await
}
